<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My LBD app</title>
</head>
<body>

    <!-- Load IFC button (hidden until tools ready) -->
    <button id="load-ifc" onclick="document.getElementById('file-input').click()" style="display: none;">Load IFC</button>
    <input type="file" accept=".ifc" id="file-input" style="display: none;">

    <script type="module">

        import { IfcAPI, IFCRELCONNECTSPATHELEMENTS } from "./assets/web-ifc-fixed.js";

        // First init web-ifc and Oxigraph
        const ifcAPI = new IfcAPI();
        initWebIFC();

        // Event listening
        document.getElementById("file-input").addEventListener("change", ev => processIFC(ev));

        // The main function that loads and processes the IFC
        async function processIFC(ev){
            
            // Get file
            const file = ev.target.files[0];

            // Hide IFC upload button
            document.getElementById("load-ifc").style.display = "none";

            // Read file content to array buffer
            const arrayBuffer = await readFile(file);
            
            // Load in web-ifc
            const modelID = ifcAPI.OpenModel(new Uint8Array(arrayBuffer));

            // MODEL IS NOW LOADED AND AVAILABLE IN MEMORY
            // DO WHATEVER OPRATIONS WHILE YOU HAVE IT
            console.log("Model loaded");

            // To validate, let's get the spaces
            const relIDs = ifcAPI.GetLineIDsWithType(modelID, IFCRELCONNECTSPATHELEMENTS);
            for (let i = 0; i < relIDs.size(); i++) {
                const expressID = relIDs.get(i);
                
                // Get rel properties
                const properties = await ifcAPI.properties.getItemProperties(modelID, expressID);
                const relatedElementID = properties.RelatedElement.value;
                const relatingElementID = properties.RelatingElement.value;

                const [relating, related] = await Promise.all([
                    getGlobalID(modelID, relatingElementID),
                    getGlobalID(modelID, relatedElementID)
                ])

                console.log(`${relating} -> ${related}`);
            }

            // Always close after use
            ifcAPI.CloseModel(modelID);

        }

        async function getGlobalID(modelID, expressID){
            const properties = await ifcAPI.properties.getItemProperties(modelID, expressID);
            return properties.GlobalId.value;
        }

        async function initWebIFC(){
            ifcAPI.SetWasmPath("./assets/");
            await ifcAPI.Init();
            console.log("web-ifc Ready");
            document.getElementById("load-ifc").style.display = "block"; // Show button for loading IFC
        }

        // Helper that takes a file and returns an arrayBuffer as promise
        async function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader()
                reader.addEventListener("loadend", (e) => resolve(e.target.result));
                reader.addEventListener("error", reject);
                reader.readAsArrayBuffer(file);
            })
        }

    </script>

</body>
</html>