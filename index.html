<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My LBD app</title>
</head>
<body>

    <!-- Load IFC button (hidden until tools ready) -->
    <button id="load-ifc" onclick="document.getElementById('ifc-input').click()" style="display: none;">
        Load IFC
    </button>
    <input type="file" accept=".ifc" id="ifc-input" style="display: none;">
    
    <!-- Load RDF button (hidden until tools ready) -->
    <button id="load-rdf" onclick="document.getElementById('rdf-input').click()" style="display: none;">
        Load RDF
    </button>
    <input type="file" accept=".nq" id="rdf-input" style="display: none;">

    <!-- Change space names (hidden until IFC or RDF loaded) -->
    <button id="change-space-names" style="display: none;">Change space names</button>

    <!-- Download button (hidden until IFC or RDF loaded) -->
    <button id="download" style="display: none;">Download RDF</button>

    <!-- Storey selector (hidden until IFC or RDF loaded) -->
    <select name="storey-select" id="storey-select" style="display: none;">
    </select>

    <p id="store-size"></p>

    <ul id="space-list"></ul>

    <script src="https://unpkg.com/jsonld@8.2.0/dist/jsonld.min.js"></script>
    <script type="importmap">
        {
          "imports": {
            "web-ifc": "https://unpkg.com/web-ifc@0.0.41/web-ifc-api.js",
            "ifc-lbd": "https://unpkg.com/ifc-lbd@0.3.7/dist/index.js",
            "async-oxigraph": "https://unpkg.com/async-oxigraph@0.0.6/dist/index.js",
            "jsonld": "https://unpkg.com/jsonld@8.2.0/dist/jsonld.esm.js",
            "rxjs": "https://unpkg.com/rxjs@7.5.4/dist/esm/index.js",
            "tslib": "https://unpkg.com/tslib@2.3.1/tslib.es6.js"
          }
        }
    </script>

    <script type="module">
        import { LBDParser, ParserSettings } from "ifc-lbd";
        import { IfcAPI } from "web-ifc";
        import { AsyncOxigraph } from "async-oxigraph";

        // First init web-ifc and Oxigraph
        const ifcAPI = new IfcAPI();
        const asyncOxigraph = new AsyncOxigraph("./assets/oxigraph/worker.js");
        initWebIFCAndOxigraph();

        // Event listening
        document.getElementById("ifc-input").addEventListener("change", ev => processIFC(ev));
        document.getElementById("rdf-input").addEventListener("change", ev => loadRDF(ev));
        document.getElementById("storey-select").addEventListener("change", ev => getStoreyData(ev.target.value));
        document.getElementById("download").addEventListener("click", ev => downloadStoreContent(ev));
        document.getElementById("change-space-names").addEventListener("click", () => changeSpaceNames());

        // The main function that loads and processes the IFC
        async function processIFC(ev){
            
            // Get file
            const file = ev.target.files[0];

            // Hide IFC and RDF upload button
            document.getElementById("load-ifc").style.display = "none";
            document.getElementById("load-rdf").style.display = "none";

            // Read file content to array buffer
            const arrayBuffer = await readFile(file);
            
            // Load in web-ifc
            const modelID = ifcAPI.OpenModel(new Uint8Array(arrayBuffer));

            // Parse LBD triples
            const settings = new ParserSettings();
            settings.namespace = "https://my-first-lbd-app.org/projects/1234/";
            settings.subsets.FSO = false;
            const lbdParser = new LBDParser(settings);
            const jsonldTriples = await lbdParser.parse(ifcAPI, modelID);

            // Convert to NQuads
            const nquads = await jsonld.normalize(jsonldTriples);

            // Load in in-memory-triplestore
            await loadInStore(nquads);

            // Always close after use
            ifcAPI.CloseModel(modelID);

        }

        async function loadRDF(ev){
            // Get file
            const file = ev.target.files[0];
            
            const reader = new FileReader();
            reader.readAsText(file, "UTF-8");
            reader.onload = async (evt) => {
                await loadInStore(evt.target.result);
                document.getElementById("load-ifc").style.display = "none";
                document.getElementById("load-rdf").style.display = "none";
            }
            reader.onerror = (err) => console.error(err);
        }

        async function loadInStore(nquads){

            // Load triples into the store
            await asyncOxigraph.load(nquads, "application/n-quads");

            document.getElementById("download").style.display = "block";
            document.getElementById("change-space-names").style.display = "block";

            await getStoreSize();
            await populateStoreySelect();
        }

        async function populateStoreySelect(){
            const query = `PREFIX bot: <https://w3id.org/bot#>
            PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> 
            SELECT ?uri ?name ?spaceCount
            WHERE { 
                ?uri a bot:Storey ;
                    rdfs:label ?name
                OPTIONAL {
                    SELECT ?uri (COUNT(?s) AS ?spaceCount)
                    WHERE{
                        ?uri bot:hasSpace ?s
                    } GROUP BY ?uri
                }
            }
            ORDER BY ?name`;
            const {data} = await asyncOxigraph.query(query);

            // Add options to storey-select
            const select = document.getElementById("storey-select");
            data.results.bindings.forEach((b, i) => {
                const option = document.createElement('option');
                const spaceCount = b.spaceCount.value ?? 0;
                option.text = `${b.name.value} [${spaceCount}]`;
                option.value = b.uri.value;
                select.add(option, i);

                // For first option, also get storey data
                if(i === 0) getStoreyData(b.uri.value);
            });

            // Display button for getting spaces after loading
            document.getElementById("storey-select").style.display = "block";
        }

        async function changeSpaceNames(){
            // Suffix all space names with _{year}
            const query = `PREFIX bot: <https://w3id.org/bot#>
            PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> 
            DELETE{
                ?s rdfs:label ?oldName
            }
            INSERT{
                ?s rdfs:label ?newName
            }
            WHERE {
                BIND(STR( YEAR( NOW() ) ) AS ?year)
                ?s a bot:Space ;
                    rdfs:label ?oldName .
                BIND(CONCAT(?oldName, "_", ?year) AS ?newName)
            }`;
            await asyncOxigraph.query(query);
        }

        async function getStoreSize(){
            const query = `SELECT (COUNT(*) AS ?count) WHERE { ?s ?p ?o }`;
            const {data} = await asyncOxigraph.query(query);
            const storeSize = data.results.bindings[0].count.value;
            document.getElementById("store-size").innerHTML = `<b>${storeSize} triples</b> in Oxigraph store`;
        }

        async function getStoreyData(storeyURI){
            const query = `PREFIX bot: <https://w3id.org/bot#>
            PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> 
            SELECT ?space ?name WHERE {
                <${storeyURI}> bot:hasSpace ?space .
                ?space rdfs:label ?name
            } ORDER BY ?name`;
            const {data} = await asyncOxigraph.query(query, "application/ld+json");
            const list = document.getElementById("space-list");
            list.innerHTML = "";
            data.results.bindings.forEach(b => {
                const item = document.createElement('li');
                item.innerHTML = b.name.value;
                item.id = b.space.value;
                item.style.cursor = "pointer";
                item.addEventListener("click", (ev) => console.log(ev.target.id));
                list.appendChild(item);
            });
        }

        async function initWebIFCAndOxigraph(){
            ifcAPI.SetWasmPath("./assets/");
            await Promise.all([
                asyncOxigraph.init(),
                ifcAPI.Init()
            ]);
            console.log("web-ifc and Oxigraph Ready");
            document.getElementById("load-ifc").style.display = "block"; // Show button for loading IFC
            document.getElementById("load-rdf").style.display = "block"; // Show button for loading RDF
        }

        // Helper that takes a file and returns an arrayBuffer as promise
        async function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader()
                reader.addEventListener("loadend", (e) => resolve(e.target.result));
                reader.addEventListener("error", reject);
                reader.readAsArrayBuffer(file);
            })
        }

        async function downloadStoreContent(){
            const {data} = await asyncOxigraph.dump();
            download("data.nq", data);
        }

        function download(filename, text) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:application/n-quads;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

    </script>

</body>
</html>